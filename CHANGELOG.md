# 更新日志 / Changelog

本文档记录 Lucky Star Bot 的版本更新历史。

---

## v2.9.0 (2026-01-08)

### 🔒 安全修复 / Security Fixes
- **P0 敏感数据保护** - 移除日志中的用户敏感信息泄露风险
- **P0 竞态条件修复** - 即时抽奖奖品分配增加行级锁 (`FOR UPDATE SKIP LOCKED`)，防止超发
- **P0 容器安全加固** - Docker 容器使用非特权用户运行，防止逃逸攻击
- **P1 安全响应头** - Nginx 配置添加 CSP、X-Frame-Options、X-Content-Type-Options 等安全头
- **P2 隐藏文件保护** - 阻止对 `.git`、`.env` 等敏感文件的访问

### ⚡ 性能优化 / Performance
- **TON API 重试机制** - 添加指数退避重试 (最多3次)，提升网络稳定性
- **TON API 限流保护** - 添加请求间隔 (50ms)，防止触发 API 限流
- **余额查询缓存** - TON/Jetton 余额短期缓存 (30秒)，减少重复请求
- **数据库连接池** - 配置最大连接数、空闲连接、生命周期，提升高并发稳定性

### 🎨 UI/UX 优化
- **图标优化** - 「持有代币」图标更换为通用代币风格 (青绿色 $)
- **图标优化** - 「注册年份」图标更换为日历风格 (紫色)
- **列表圆角** - 列表组件圆角从 10px 增加到 16px

### 🔧 技术改进
- **统一错误处理** - 前端 Axios 添加响应拦截器，统一处理 API 错误
- **Docker Build Cache 清理** - 回收 12.4GB 磁盘空间
- **数据库自动备份** - 每日凌晨 3:00 自动备份，保留 7 天
- **Redis 碎片整理** - 启用 activedefrag 优化内存使用

---

## v2.8.0 (2026-01-08)

### ✨ 新功能 / New Features
- **审批流程增强**
  - **状态页面** - 待审批 (`pending_approval`) 和 已拒绝 (`rejected`) 状态现在有专门的展示页面，分别提示 "等待频道管理员审核" 和 "此抽奖已被管理员拒绝"
  - **创建通知** - 非群主创建活动时，通知提示调整为 "等待群主审核"，不再显示 "活动创建成功"
- **自定义代币验证增强**
  - "持有 Jetton" 升级为 **"自定义代币验证"**，支持直接输入合约地址
  - 新增常用代币模板 (USDT, Notcoin, Dogs, Hamster, Catizen, STON, DeDust)
  - 自动识别并显示代币信息，支持全局抽奖活动
- **列表折叠功能**
  - "已结束" 列表超过3项时自动折叠
  - 新增 "展开更多" / "收起" 按钮
- **"我的抽奖" 列表优化**
  - "已创建" 标签页新增展示 "待审批" 和 "已拒绝" 的活动
  - 支持创建者/管理员直接删除这些状态的活动

### 🎨 UI/UX 优化
- **输入体验** - 优化合约地址输入框，增加 TON 网络提示 (`EQ/UQ` 开头)
- **图标升级** - 更新所有代币图标为高清版本，自定义代币采用比特币风格图标
- **空状态优化** - 修复了列表为空时的显示文案

### 🔧 技术改进
- **多语言完善** - 全面覆盖状态文案、折叠按钮及代币验证的中英文翻译
- **逻辑验证** - 验证通过了代币数值转换逻辑 (Nano单位自动换算)

## v2.7.0 (2026-01-06)

### ✨ 新功能
- **官方认证标识** - 管理员创建的抽奖活动将在列表中显示"官方"金色星标(⭐)
- **管理员管理通知** - 创建抽奖后，管理员会收到包含管理/置顶链接的私信通知

### ⚡ 性能优化
- **极速开奖算法** - 采用"乐观抽选"机制，将万人规模的开奖时间从分钟级缩短至秒级
- **并发与限流增强** - 优化了 Telegram API 的调用频率控制，防止大规模开奖时触发限制

### 🔧 技术改进
- 优化了无效参与者的清理逻辑，采用异步延迟清理以提升主流程速度

## v2.6.0 (2026-01-04)

### ✨ 新功能
- **积分/发言统计来源选择** - 创建活动时可指定从哪个群组/频道统计，默认合并所有绑定群组
- **群组/频道类型区分** - 参与要求显示"加入群组"或"订阅频道"，更加准确
- **一键复制卡密** - 中奖通知新增"复制卡密"按钮，点击即可复制到剪贴板（Bot API 7.11+）

### 🔧 技术改进
- **有效发言规则增强** - 新增以下无效发言过滤：
  - 纯数字消息
  - 纯表情包消息
  - 重复字符消息（如"哈哈哈哈"、"好好好"）

### 🐛 问题修复
- 修复参与要求显示用户名而非群组名称的问题
- 修复群组点击无法正确跳转的问题
- 修复多群组积分统计时只读取第一个群组的问题

---

## v2.5.0 (2026-01-03)

### ✨ 新功能
- **卡密使用地址** - 自动发奖模式下可设置激活码使用地址，中奖者可一键打开
- **CSV批量导入增强** - 批量导入奖品时支持设置使用地址列

### 🐛 问题修复
- 修复编辑已有奖品时，高级字段不会预填充的问题
- 修复创建抽奖时联系人字段未正确发送的问题

---

## v2.4.0 (2026-01-01)

### ✨ 新功能
- **可验证公平抽奖** - 引入密码学承诺方案，实现可审计的公平开奖
- **开奖凭证** - 生成完整的开奖证明，任何人可独立验证结果
- **区块链随机源** - 集成TON区块链和drand信标作为外部随机源
- **中奖通知优化** - 开奖消息中显示公平性验证信息

### 🔧 技术改进
- 使用HMAC-SHA256作为确定性随机数生成器
- 采用Fisher-Yates算法进行公平洗牌
- 服务器密钥使用AES-256-GCM加密存储

---

## v2.3.0 (2025-12-30)

### ✨ 新功能
- **参与者列表增强** - 点击参与者头像可直接打开私聊
- **群组/频道状态刷新** - 自动更新已绑定群组的公开/私有状态

### 🐛 问题修复
- 修复私有群组转公开后仍无法验证的问题
- 修复翻译同步问题

---

## v2.2.0 (2025-12-28)

### ✨ 新功能
- **桌面端频道搜索** - 桌面用户可直接搜索频道/群组添加机器人
- **口令抽奖通知** - 用户通过口令参与后显示当前参与人数

### 🎨 界面优化
- 优化Telegram消息格式，移除过长的分隔线
- 移动端消息渲染更加美观

---

## v2.1.0 (2025-12-25)

### ✨ 新功能
- **查看结果按钮** - 通知消息中的按钮直接打开Mini App
- **即时抽奖结果** - 未中奖用户显示"很遗憾"而非倒计时

### 🐛 问题修复
- 修复人数满额后仍可加入的并发问题
- 修复Telegram API失败时的错误处理

---

## v2.0.0 (2025-12-24)

### 🚀 重大更新
- **全新UI设计** - 采用现代化Telegram Mini App界面
- **多语言支持** - 支持14种语言
- **订阅要求增强** - 同时支持频道和群组订阅

### ✨ 新功能
- 即时抽奖模式
- 自定义图片上传
- 积分系统
- TON链上验证

---

## v1.0.0 (2025-11-01)

### 🎉 首次发布
- 基础抽奖功能
- 定时开奖
- 人数开奖
- 订阅频道要求
- 中英文双语支持

---

<p align="center">
  <i>持续更新中...</i>
</p>
